# vim: syntax=bash

@goal serve
@doc 'serves local development jekyll server'
  bundle exec jekyll serve -w

@goal deploy_rsa_encrypt
@doc 'prepares deploy_rsa.enc'
  echo 'Enter pass:'
  read PASS
  openssl aes-256-cbc -e -in ~/Downloads/deploy_rsa -out ./deploy_rsa.enc -k "$PASS"
  echo $'File deploy_rsa.enc is changed. Don\'t forget to commit.'

@define OPENSSL_URL='https://www.openssl.org/source/old/1.1.1/openssl-1.1.1l.tar.gz'

@goal openssl_installed
@reached_if [[ -e ./soft/openssl ]]
@depends_on soft_folder_created
  cd soft
  wget "$OPENSSL_URL" -O openssl.tar.gz
  tar xzvf openssl.tar.gz
  cd openssl-1.*
  ./config
  make
  cp \
    ./apps/openssl \
    libssl.so.1.1 \
    libcrypto.so.1.1 \
    ..
  cd ..
  ./openssl version
  rm -r openssl.tar.gz openssl-1.*

@goal soft_folder_created @private
@reached_if [[ -d "soft" ]]
  mkdir soft

@goal deploy_rsa_decrypted
@doc '[github] decrypts deploy_rsa'
  if [[ -z "$DEPLOY_RSA_KEY" ]]
  then
    echo 'DEPLOY_RSA_KEY env variable missing (should be set in https://github.com/xonixx/cml-site-jekyll/settings/secrets/actions)'
    exit 1
  fi

  openssl aes-256-cbc -k "$DEPLOY_RSA_KEY" \
    -in deploy_rsa.enc                     \
    -out /tmp/deploy_rsa -d

@goal deploy-master
@doc '[github] deploys test version of site at next.cmlteam.com'
@depends_on deploy_rsa_decrypted
  echo 'Deploying next ...'

@goal deploy-prod
@doc '[github] deploys prod version of site at www.cmlteam.com'
  echo 'Deploying prod ...'

